<%- include('partials/header') %>

<style>
    .table-card { background: white; border-radius: 12px; border: 1px solid var(--border); box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.05); overflow-x: auto; margin-bottom: 32px; }
    table { width: 100%; border-collapse: collapse; font-size: 13px; min-width: 800px; }
    th, td { padding: 12px 16px; border-bottom: 1px solid var(--border); text-align: left; vertical-align: middle; }
    th { background-color: var(--table-header, #f8fafc); color: var(--text-muted); text-transform: uppercase; font-size: 11px; font-weight: 700; letter-spacing: 0.03em; }
    
    .inline-input, .inline-select { width: 100%; padding: 8px 12px; border: 1px solid transparent; border-radius: 6px; font-family: inherit; font-size: 13px; color: var(--text-main); outline: none; transition: all 0.2s; background: #f8fafc; }
    .inline-input:hover, .inline-select:hover { border-color: #cbd5e1; }
    .inline-input:focus, .inline-select:focus { border-color: var(--primary); background: #ffffff; box-shadow: 0 0 0 3px rgba(16, 185, 129, 0.1); }
    .inline-input.code-input { font-family: monospace; font-weight: 700; color: #475569; }
    .inline-input.name-input { font-weight: 700; color: #0f172a; }

    .form-header { display: flex; justify-content: space-between; align-items: flex-end; margin-bottom: 16px; flex-wrap: wrap; gap: 16px; }
    .btn-save-all { background: var(--primary); color: white; border: none; padding: 10px 24px; border-radius: 8px; font-weight: 700; font-size: 14px; cursor: pointer; transition: all 0.2s; display: flex; align-items: center; gap: 8px; box-shadow: 0 4px 10px rgba(16, 185, 129, 0.2); white-space: nowrap; position: sticky; top: 20px; z-index: 10; }
    .btn-save-all:hover { background: #059669; transform: translateY(-1px); box-shadow: 0 6px 12px rgba(16, 185, 129, 0.3); }

    .section-title { font-size: 16px; font-weight: 800; color: #0f172a; margin-bottom: 12px; display: flex; align-items: center; gap: 8px; margin-top: 24px;}
    .icon-client { color: #3b82f6; }
    .icon-vendor { color: #10b981; }
    .icon-unassigned { color: #94a3b8; }

    @media (max-width: 768px) { .form-header { flex-direction: column; align-items: stretch; } .btn-save-all { justify-content: center; position: relative; top: 0;} }
</style>

<div class="grid-container">
    <% 
        const safeRole = (r) => (r || '').trim().toUpperCase();
        const clients = groups.filter(g => safeRole(g.role) === 'CLIENT');
        const vendors = groups.filter(g => safeRole(g.role) === 'VENDOR');
        const unassigned = groups.filter(g => safeRole(g.role) !== 'CLIENT' && safeRole(g.role) !== 'VENDOR');
    %>

    <form action="/groups/bulk-update" method="POST">
        
        <div class="form-header">
            <div>
                <h1 style="margin: 0; font-size: 24px;">Group Management</h1>
                <p style="color: var(--text-muted); margin: 4px 0 0 0;">Edit names, roles, tiers, and short-codes for all groups inline.</p>
            </div>
            <button type="submit" class="btn-save-all">
                <i data-lucide="save" style="width: 18px;"></i> Save All Changes
            </button>
        </div>

        <div class="section-title"><i data-lucide="users" class="icon-client" style="width: 20px;"></i> Active Clients (<%= clients.length %>)</div>
        <div class="table-card">
            <table>
                <thead><tr><th width="35%">Group Name</th><th width="20%">Short Code</th><th width="20%">Role Assignment</th><th width="25%">Usage Tier</th></tr></thead>
                <tbody>
                    <% if (clients.length === 0) { %><tr><td colspan="4" style="text-align:center; padding: 30px; color:#64748b;">No active clients found.</td></tr><% } %>
                    <% clients.forEach(group => { %>
                        <tr>
                            <td>
                                <div style="display: flex; align-items: center; gap: 8px;">
                                    <i data-lucide="message-square" style="width: 16px; color:#94a3b8;"></i>
                                    <input type="text" name="group_name[]" value="<%= group.name %>" class="inline-input name-input" required>
                                </div>
                                <input type="hidden" name="group_id[]" value="<%= group.group_id %>">
                            </td>
                            <td>
                                <div style="display: flex; align-items: center; gap: 6px;">
                                    <span style="color: #cbd5e1; font-weight: bold; font-family: monospace;">#</span>
                                    <input type="text" name="client_code[]" value="<%= group.client_code || '' %>" class="inline-input code-input" placeholder="101" required>
                                </div>
                            </td>
                            <td>
                                <select name="role[]" class="inline-select">
                                    <option value="NONE">NONE (Disabled)</option>
                                    <option value="CLIENT" selected>CLIENT</option>
                                    <option value="VENDOR">VENDOR</option>
                                </select>
                            </td>
                            <td><input type="text" name="limit_tier[]" value="<%= group.limit_tier || 'DEFAULT' %>" class="inline-input"></td>
                        </tr>
                    <% }); %>
                </tbody>
            </table>
        </div>

        <div class="section-title"><i data-lucide="building-2" class="icon-vendor" style="width: 20px;"></i> Active Vendors (<%= vendors.length %>)</div>
        <div class="table-card">
            <table>
                <thead><tr><th width="35%">Group Name</th><th width="20%">Short Code</th><th width="20%">Role Assignment</th><th width="25%">Usage Tier</th></tr></thead>
                <tbody>
                    <% if (vendors.length === 0) { %><tr><td colspan="4" style="text-align:center; padding: 30px; color:#64748b;">No active vendors found.</td></tr><% } %>
                    <% vendors.forEach(group => { %>
                        <tr>
                            <td>
                                <div style="display: flex; align-items: center; gap: 8px;">
                                    <i data-lucide="message-square" style="width: 16px; color:#94a3b8;"></i>
                                    <input type="text" name="group_name[]" value="<%= group.name %>" class="inline-input name-input" required>
                                </div>
                                <input type="hidden" name="group_id[]" value="<%= group.group_id %>">
                            </td>
                            <td>
                                <div style="display: flex; align-items: center; gap: 6px;">
                                    <span style="color: #cbd5e1; font-weight: bold; font-family: monospace;">#</span>
                                    <input type="text" name="client_code[]" value="<%= group.client_code || '' %>" class="inline-input code-input" placeholder="V1" required>
                                </div>
                            </td>
                            <td>
                                <select name="role[]" class="inline-select">
                                    <option value="NONE">NONE (Disabled)</option>
                                    <option value="CLIENT">CLIENT</option>
                                    <option value="VENDOR" selected>VENDOR</option>
                                </select>
                            </td>
                            <td><input type="text" name="limit_tier[]" value="<%= group.limit_tier || 'DEFAULT' %>" class="inline-input"></td>
                        </tr>
                    <% }); %>
                </tbody>
            </table>
        </div>

        <div class="section-title"><i data-lucide="help-circle" class="icon-unassigned" style="width: 20px;"></i> Unassigned / Disabled Groups (<%= unassigned.length %>)</div>
        <div class="table-card">
            <table>
                <thead><tr><th width="35%">Group Name</th><th width="20%">Short Code</th><th width="20%">Role Assignment</th><th width="25%">Usage Tier</th></tr></thead>
                <tbody>
                    <% if (unassigned.length === 0) { %><tr><td colspan="4" style="text-align:center; padding: 30px; color:#64748b;">No unassigned groups.</td></tr><% } %>
                    <% unassigned.forEach(group => { %>
                        <tr>
                            <td>
                                <div style="display: flex; align-items: center; gap: 8px;">
                                    <i data-lucide="message-square" style="width: 16px; color:#94a3b8;"></i>
                                    <input type="text" name="group_name[]" value="<%= group.name %>" class="inline-input name-input" required>
                                </div>
                                <input type="hidden" name="group_id[]" value="<%= group.group_id %>">
                            </td>
                            <td>
                                <div style="display: flex; align-items: center; gap: 6px;">
                                    <span style="color: #cbd5e1; font-weight: bold; font-family: monospace;">#</span>
                                    <input type="text" name="client_code[]" value="<%= group.client_code || '' %>" class="inline-input code-input" placeholder="e.g. 101" required>
                                </div>
                            </td>
                            <td>
                                <select name="role[]" class="inline-select">
                                    <option value="NONE" selected>NONE (Disabled)</option>
                                    <option value="CLIENT">CLIENT</option>
                                    <option value="VENDOR">VENDOR</option>
                                </select>
                            </td>
                            <td><input type="text" name="limit_tier[]" value="<%= group.limit_tier || 'DEFAULT' %>" class="inline-input"></td>
                        </tr>
                    <% }); %>
                </tbody>
            </table>
        </div>
        
    </form>
</div>

<%- include('partials/footer') %>